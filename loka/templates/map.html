{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap_toolkit %}
{% block title %}Loka Minecraft - Territory Map{% endblock %}
{% block extra_head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css">
{% endblock %}

{% block content %}
    <section class="features text-center section-padding" id="features">
        <div id="map" style="width: 100%; height: 700px; position: relative;"
             class="leaflet-container leaflet-fade-anim"
             tabindex="0">
        </div>

        <script src="{% static 'js/leaflet.js' %}"></script>
        <script src="{% static 'js/convex_hull.js' %}"></script>
        <script>
            // See https://github.com/CloudMade/Leaflet/issues/980
            L.CRS.Simple = L.Util.extend({}, L.CRS, {
                projection: L.Projection.LonLat,
                transformation: new L.Transformation(.5, .5, .5, .5)
            });

            var map = new L.Map('map', {
                crs: L.CRS.Simple,
                center: [0.0, 0.0],
                worldCopyJump: false
            });

            L.tileLayer('/static/images/map/{z}/{x}/{y}.jpg', {
                noWrap: true,
                minZoom: 2,
                maxZoom: 5
            }).addTo(map);

            map.setView([0, 0], 3);

            L.marker([-.002252642, .002252642]).addTo(map).bindPopup('Spawn').openPopup();
            L.circle([-.002252642, .002252642], 700.0, {color: 'blue', fillColor: 'blue'}).addTo(map).bindPopup('Spawn');

            {% for town in towns %}
                {% if town.has_territories and town.latitude and town.longitude %}
                    L.marker([{{ town.latitude }}, {{ town.longitude }}]).addTo(map).bindPopup('{{ town.name }}');
                    {#                    L.circle([{{ town.latitude }}, {{ town.longitude }}], 1000.0, { color: 'yellow', fillColor: 'yellow', fillOpacity: 0.4}).addTo(map).bindPopup('{{ town.name }}');#}
                {% endif %}
            {% endfor %}

            {% for territory in territories %}
                {% if territory.town.has_territories and territory.latitude and territory.longitude %}

                    var points = [];
                    var hullPoints = [];
                    var hullPoints_size;

                    points.push([{{ territory.latitude }}, {{ territory.longitude }}]);
                    points.sort(sortPointY);
                    points.sort(sortPointX);
                    hullPoints_size = chainHull_2D(points, points.length, hullPoints);
                    {#                    L.polygon(hullPoints, {color: 'red'}).addTo(map).bindPopup('Territory');#}

                    {% if territory.conflicted %}
                        L.polygon(hullPoints, { color: 'red', fillColor: 'red', fillOpacity: 0.5}).addTo(map).bindPopup('{{ territory.town.name }} Territory (Under Attack)');
                    {% else %}
                        L.polygon(hullPoints, { color: 'yellow', fillColor: 'yellow', fillOpacity: 0.5}).addTo(map).bindPopup('{{ territory.town.name }} Territory');
                    {% endif %}
                {% endif %}
            {% endfor %}


            {#        var popup = L.popup();#}
            {##}
            {#        function onMapClick(e) {#}
            {#            popup#}
            {#                    .setLatLng(e.latlng)#}
            {#                    .setContent("You clicked the map at " + e.latlng.toString())#}
            {#                    .openOn(map);#}
            {#        }#}
            {##}
            {#        map.on('click', onMapClick);#}
        </script>
    </section>
{% endblock %}