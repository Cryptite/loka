{% extends "base.html" %}
{% load staticfiles %}
{% load bootstrap_toolkit %}
{% block title %}Loka Minecraft - Territory Map{% endblock %}
{% block extra_head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css">
{% endblock %}

{% block content %}
    <div id="map" style="width: 100%; height: 700px; position: relative;" class="leaflet-container leaflet-fade-anim"
         tabindex="0">
    </div>

    <script src="{% static 'js/leaflet.js' %}"></script>
    <script src="{% static 'js/convex_hull.js' %}"></script>
    <script type="text/javascript">
        // See https://github.com/CloudMade/Leaflet/issues/980
        L.CRS.Simple = L.Util.extend({}, L.CRS, {
            projection: L.Projection.LonLat,
            transformation: new L.Transformation(.5, .5, .5, .5)
        });

        var map = new L.Map('map', {
            crs: L.CRS.Simple,
            center: [0.0, 0.0],
            worldCopyJump: false
        });

        L.tileLayer('/static/images/map/{z}/{x}/{y}.jpg', {
            noWrap: true,
            minZoom: 2,
            maxZoom: 5
        }).addTo(map);

        map.setView([0, 0], 3);

        L.marker([-.002252642, .002252642]).addTo(map).bindPopup('Spawn').openPopup();
        L.circle([-.002252642, .002252642], 1200.0, {color: 'blue', fillColor: 'blue'}).addTo(map).bindPopup('Spawn');

        {% for town in towns %}
            {% if town.has_territories and town.latitude and town.longitude %}
                L.marker([{{ town.latitude }}, {{ town.longitude }}]).addTo(map).bindPopup('<h2>{{ town.name }}</h2><br/>Nodes: {{ town.num_territories }}<br/>Strength: {{ town.strength }}');

                var points = [];
                var hullPoints = [];
                var firstHull = [];
                var firstHullPoints_size;
                var hullPoints_size;

                {% for territory in territories %}
                    {% if territory.town == town %}
                        points.push([{{ territory.latitude }}, {{ territory.longitude }}]);

                        {#                        {% for padded in territory.get_padded %}#}
                        {#                            points.push({{ padded }});#}
                        {#                        {% endfor %}#}
                    {% endif %}

                    points.push([{{ town.latitude }}, {{ town.longitude }}]);
                    {% for padded in town.get_padded %}
                        points.push({{ padded }});
                    {% endfor %}
                {% endfor %}

                {#                hullPoints = getHull(points, 1);#}

                {#                points.sort(sortPointY);#}
                {#                points.sort(sortPointX);#}

                {#                firstHullPoints_size = getHull(points, points.length, firstHull);#}
                {#                firstHull.sort(sortPointY);#}
                {#                firstHull.sort(sortPointX);#}

                {#                points.sort(sortPointY);#}
                {#                points.sort(sortPointX);#}
                hullPoints = getHull(points, 3);

                {#                for (var i = 0; i < hullPoints.length; i++) {#}
                {#                    L.marker(hullPoints[i]).addTo(map);#}
                {#                }#}

                {% if town.has_territory_conflicted %}
                    L.polygon(hullPoints, { color: 'red', fillColor: 'red', fillOpacity: 0.5, smoothFactor: 1}).addTo(map).bindPopup('{{ town.name }} Territory (Under Attack)');
                {% else %}
                    L.polygon(hullPoints, { color: 'yellow', fillColor: 'yellow', fillOpacity: 0.5, smoothFactor: 1}).addTo(map).bindPopup('{{ town.name }} Territory');
                {% endif %}
            {% endif %}
        {% endfor %}

        {#        {% for territory in territories %}#}
        {#            {% if territory.town.has_territories and territory.latitude and territory.longitude %}#}
        {##}
        {#                var points = [];#}
        {#                var hullPoints = [];#}
        {#                var hullPoints_size;#}
        {##}
        {#                points.push([{{ territory.latitude }}, {{ territory.longitude }}]);#}
        {#                points.sort(sortPointY);#}
        {#                points.sort(sortPointX);#}
        {#                hullPoints_size = chainHull_2D(points, points.length, hullPoints);#}
        {#                    L.polygon(hullPoints, {color: 'red'}).addTo(map).bindPopup('Territory');#}
        {##}
        {#                {% if territory.conflicted %}#}
        {#                    L.polygon(hullPoints, { color: 'red', fillColor: 'red', fillOpacity: 0.5}).addTo(map).bindPopup('{{ territory.town.name }} Territory (Under Attack)');#}
        {#                {% else %}#}
        {#                    L.polygon(hullPoints, { color: 'yellow', fillColor: 'yellow', fillOpacity: 0.5}).addTo(map).bindPopup('{{ territory.town.name }} Territory');#}
        {#                {% endif %}#}
        {#            {% endif %}#}
        {#        {% endfor %}#}

        {#        var popup = L.popup();#}
        {##}
        {#        function onMapClick(e) {#}
        {#            popup#}
        {#                    .setLatLng(e.latlng)#}
        {#                    .setContent("You clicked the map at " + e.latlng.toString())#}
        {#                    .openOn(map);#}
        {#        }#}
        {##}
        {#        map.on('click', onMapClick);#}
    </script>
{% endblock %}
